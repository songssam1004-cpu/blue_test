<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>BLE ì²´ì¤‘ê³„ ì—°ê²°</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button {
      padding: 12px 20px; background:#4a90e2; color:white;
      border:none; border-radius:6px; cursor:pointer; font-size:16px;
    }
    #log { 
      margin-top:20px; background:#f5f5f5; padding:15px;
      height:200px; overflow-y:auto; white-space:pre-line;
    }
    #weight {
      font-size: 32px; margin-top: 20px; font-weight: bold;
    }
  </style>
</head>
<body>

<h1>ë¸”ë£¨íˆ¬ìŠ¤ ì²´ì¤‘ê³„ ì—°ê²°</h1>
<button id="connectBtn">ì²´ì¤‘ê³„ ì—°ê²°í•˜ê¸°</button>

<div id="weight">ëª¸ë¬´ê²Œ: -- kg</div>
<div id="log"></div>

<script>
  const logBox = document.getElementById("log");
  const weightBox = document.getElementById("weight");

  function log(msg) {
    logBox.textContent += msg + "\n";
  }

  document.getElementById("connectBtn").addEventListener("click", async () => {

    try {
      log("ğŸ” ì²´ì¤‘ê³„ ê²€ìƒ‰ ì‹œì‘...");

      const device = await navigator.bluetooth.requestDevice({
        filters: [{
          services: ["weight_scale"]   // UUID: 0x181D
        }]
      });

      log("ğŸ“¡ ì„ íƒí•œ ì¥ì¹˜: " + device.name);

      const server = await device.gatt.connect();
      log("ğŸ”— GATT ì„œë²„ ì—°ê²°ë¨");

      const service = await server.getPrimaryService("weight_scale");
      const characteristic = await service.getCharacteristic("weight_measurement");

      log("âš™ï¸ Weight Measurement Characteristic êµ¬ë… ì‹œì‘...");
      await characteristic.startNotifications();

      characteristic.addEventListener("characteristicvaluechanged", (event) => {
        const value = event.target.value;

        // Weight Scale Measurement Format
        const flags = value.getUint8(0);
        const weightRaw = value.getUint16(1, true); // little-endian

        let weightKg = weightRaw / 200; // ëŒ€ë¶€ë¶„ BLE ì²´ì¤‘ê³„ëŠ” /200 ì‚¬ìš©í•¨

        weightBox.textContent = `ëª¸ë¬´ê²Œ: ${weightKg.toFixed(2)} kg`;
        log("ğŸ“¥ ë°ì´í„° ìˆ˜ì‹ : " + weightKg.toFixed(2) + " kg");
      });

    } catch (error) {
      log("â— ì˜¤ë¥˜: " + error);
    }

  });
</script>

</body>
</html>
